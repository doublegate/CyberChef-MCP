FROM node:22-alpine

WORKDIR /app

COPY package.json package-lock.json ./

# Install dependencies without running postinstall (which needs Gruntfile)
RUN npm ci --ignore-scripts

# Copy all source files
COPY . .

# Apply patches for Node 22 compatibility (SlowBuffer deprecation)
# These packages use the deprecated SlowBuffer which was removed/changed in newer Node versions
RUN sed -i 's/new SlowBuffer/Buffer.alloc/g' node_modules/avsc/lib/types.js && \
    sed -i 's/SlowBuffer/Buffer/g' node_modules/buffer-equal-constant-time/index.js

# Run postinstall scripts (fixes imports etc. defined in package.json)
RUN npm run postinstall

# Generate CyberChef configuration and Node index
RUN npx grunt configTests

# Expose the MCP server
CMD ["node", "src/node/mcp-server.mjs"]