name: "MCP Server CI"

on:
  workflow_dispatch:
  push:
    branches:
    - master
    paths:
      - 'src/core/**'
      - 'src/node/**'
      - 'package.json'
      - '.github/workflows/**'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Configure git
      run: git config --global init.defaultBranch master

    - uses: actions/checkout@v4

    - name: Set node version
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Install
      run: |
        npm install
        npm run setheapsize

    - name: Update browserslist database
      run: npx update-browserslist-db@latest

    # We need to patch the node_modules for Node 22 compatibility here as well
    # because npm install might overwrite them or they might not be patched in the repo
    - name: Patch Dependencies for Node 22
      run: |
        sed -i 's/new SlowBuffer/Buffer.alloc/g' node_modules/avsc/lib/types.js
        sed -i 's/SlowBuffer/Buffer/g' node_modules/buffer-equal-constant-time/index.js

    - name: Lint
      run: npx grunt lint

    - name: Config Tests (Generate Configs)
      run: npx grunt configTests

    - name: Unit Tests
      run: |
        npm test
        npm run testnodeconsumer

    # Codecov Integration: Coverage Analytics + Test Analytics
    - name: MCP Tests with Coverage
      run: npm run test:coverage

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v5
      if: always()
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/lcov.info
        flags: mcp-tests
        name: codecov-mcp-coverage
        fail_ci_if_error: false
        verbose: true

    - name: Upload Test Results to Codecov
      uses: codecov/test-results-action@v1
      if: always()
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./test-results/junit.xml
        flags: mcp-tests
        name: codecov-test-results
        fail_ci_if_error: false

    # NOTE: Web UI production build (npx grunt prod) removed in v1.7.1
    # This fork focuses on the MCP server implementation. The web UI files
    # (src/web/) and related build infrastructure were removed as they are
    # not needed for MCP server functionality. The production build step
    # required those deleted web UI files and would fail.
