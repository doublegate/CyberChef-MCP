name: Upstream Release Monitor

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  check-upstream:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch latest CyberChef release
        id: upstream
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get latest release from gchq/CyberChef
          LATEST_RELEASE=$(gh api repos/gchq/CyberChef/releases/latest --jq '.tag_name')
          echo "latest=$LATEST_RELEASE" >> $GITHUB_OUTPUT
          echo "Latest CyberChef release: $LATEST_RELEASE"

      - name: Get current version
        id: current
        run: |
          # Extract mcpVersion from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').mcpVersion")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current MCP version: $CURRENT_VERSION"

          # Extract CyberChef version from package.json
          CYBERCHEF_VERSION=$(node -p "require('./package.json').version")
          echo "cyberchef_version=$CYBERCHEF_VERSION" >> $GITHUB_OUTPUT
          echo "Current CyberChef version: $CYBERCHEF_VERSION"

      - name: Compare versions
        id: compare
        env:
          LATEST: ${{ steps.upstream.outputs.latest }}
          CYBERCHEF_VERSION: ${{ steps.current.outputs.cyberchef_version }}
        run: |
          CURRENT="v${CYBERCHEF_VERSION}"
          echo "Comparing: $CURRENT vs $LATEST"

          if [ "$LATEST" != "$CURRENT" ]; then
            echo "new_version=true" >> $GITHUB_OUTPUT
            echo "New version available: $LATEST (current: $CURRENT)"
          else
            echo "new_version=false" >> $GITHUB_OUTPUT
            echo "Already up-to-date"
          fi

      - name: Check for existing issue
        if: steps.compare.outputs.new_version == 'true'
        id: existing
        env:
          GH_TOKEN: ${{ github.token }}
          LATEST: ${{ steps.upstream.outputs.latest }}
        run: |
          # Check if issue already exists for this version
          ISSUE_COUNT=$(gh issue list \
            --label "upstream-release" \
            --state open \
            --search "$LATEST" \
            --json number \
            --jq 'length')

          echo "count=$ISSUE_COUNT" >> $GITHUB_OUTPUT
          echo "Found $ISSUE_COUNT existing issues for this release"

      - name: Create issue for new release
        if: steps.compare.outputs.new_version == 'true' && steps.existing.outputs.count == '0'
        env:
          GH_TOKEN: ${{ github.token }}
          LATEST: ${{ steps.upstream.outputs.latest }}
          CYBERCHEF_VERSION: ${{ steps.current.outputs.cyberchef_version }}
        run: |
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ISSUE_BODY="## New Upstream Release Detected

          CyberChef Version: $LATEST
          Current Version: v$CYBERCHEF_VERSION
          Detected: $TIMESTAMP

          ### Next Steps

          1. Review the [upstream release notes](https://github.com/gchq/CyberChef/releases/tag/$LATEST)
          2. Check for breaking changes or new operations
          3. If safe to proceed, add the \`upstream-sync-approved\` label to trigger automatic sync
          4. If manual intervention needed, sync manually and close this issue

          ### Automatic Sync

          To trigger automatic synchronization:
          \`\`\`bash
          gh issue edit <issue-number> --add-label upstream-sync-approved
          \`\`\`

          Or use the GitHub web interface to add the label.

          ### Manual Sync

          If automatic sync is not suitable:
          \`\`\`bash
          # Add upstream remote
          git remote add upstream https://github.com/gchq/CyberChef.git

          # Fetch and merge
          git fetch upstream
          git merge upstream/master

          # Regenerate configs
          npm install
          npx grunt configTests

          # Run tests
          npm test
          npm run test:mcp
          \`\`\`

          ---
          This issue was created automatically by the Upstream Release Monitor workflow."

          gh issue create \
            --title "New CyberChef release $LATEST available" \
            --label "upstream-release,needs-review" \
            --body "$ISSUE_BODY"

      - name: Summary
        env:
          LATEST: ${{ steps.upstream.outputs.latest }}
          CYBERCHEF_VERSION: ${{ steps.current.outputs.cyberchef_version }}
          MCP_VERSION: ${{ steps.current.outputs.version }}
          NEW_VERSION: ${{ steps.compare.outputs.new_version }}
          EXISTING_COUNT: ${{ steps.existing.outputs.count }}
        run: |
          echo "### Upstream Monitor Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest CyberChef:** $LATEST" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version:** v$CYBERCHEF_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **MCP Version:** $MCP_VERSION" >> $GITHUB_STEP_SUMMARY

          if [ "$NEW_VERSION" == "true" ]; then
            echo "- **Status:** New version available" >> $GITHUB_STEP_SUMMARY
            if [ "$EXISTING_COUNT" == "0" ]; then
              echo "- **Action:** Issue created" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Action:** Issue already exists" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Status:** Up-to-date" >> $GITHUB_STEP_SUMMARY
            echo "- **Action:** None" >> $GITHUB_STEP_SUMMARY
          fi
